# PDF-MCP Server 项目详细注释文档

## 项目概述

PDF-MCP Server 是一个基于 Model Context Protocol (MCP) 的强大PDF处理服务器，提供文本提取、表格识别、OCR、数学公式识别和智能文档分析功能。

## 项目结构详细说明

### 根目录文件

#### 配置文件
- **`pyproject.toml`**: Python项目配置文件，定义了项目元数据、依赖关系和构建配置
  - 项目名称: pdf-mcp-server
  - 版本: 0.1.0
  - 支持Python 3.9+
  - 包含开发、GPU和GROBID可选依赖

- **`requirements.txt`**: Python依赖包列表
  - 核心MCP框架: mcp>=1.0.0, fastapi>=0.104.0
  - PDF处理: PyMuPDF, pdfplumber, pypdf
  - 表格提取: camelot-py, tabula-py
  - OCR功能: ocrmypdf, pytesseract
  - 公式识别: torch, transformers, pix2tex

- **`README.md`**: 项目说明文档，包含安装、配置和使用指南

#### Docker配置
- **`Dockerfile`**: 多阶段构建的生产环境Docker镜像
  - 基于Python 3.11-slim
  - 安装系统依赖: tesseract-ocr, ghostscript, poppler-utils
  - 支持多语言OCR: 英文、中文、法文、德文等
  - 包含Java运行时用于Tabula表格提取
  - 可选安装GROBID和公式识别模型

- **`Dockerfile.dev`**: 开发环境Docker镜像（未在当前文件中显示）

- **`docker-compose.yml`**: 生产环境Docker Compose配置
  - 主服务: pdf-mcp-server
  - 数据库: PostgreSQL
  - 缓存: Redis
  - 可选服务: GROBID, Nginx, Prometheus, Grafana

- **`docker-compose.override.yml`**: 开发环境覆盖配置
  - 启用调试模式和代码热重载
  - 挂载源代码目录
  - 添加开发工具: Jupyter, pgAdmin, Redis Commander

### 源代码目录 (`src/pdf_mcp_server/`)

#### 主入口文件
- **`main.py`**: 服务器主入口点
  - `PDFMCPServer`类: 主服务器类，负责初始化、配置加载、工具注册
  - 配置管理: 支持JSON配置文件和默认配置合并
  - 日志设置: 可配置的日志级别和格式
  - 临时目录管理: 自动创建和清理临时文件
  - 工具注册: 根据配置启用/禁用不同功能模块
  - MCP通信: 通过stdin/stdout处理MCP协议消息

#### 工具模块 (`tools/`)
- **`__init__.py`**: 工具模块初始化文件
  - 导出所有工具类
  - 定义工具分类和描述
  - 提供工具注册和实例化函数

- **`text_extraction.py`**: 文本提取工具
  - `ReadTextTool`: 多引擎文本提取（PyMuPDF, pdfplumber, PyPDF2）
  - `ExtractMetadataTool`: PDF元数据提取
  - 支持页面选择、布局保持、注释提取

- **`table_extraction.py`**: 表格提取工具（未在当前查看中显示）
  - `ExtractTablesTool`: 基础表格提取
  - `ExtractTablesAdvancedTool`: 高级表格提取

- **`ocr_processing.py`**: OCR处理工具（未在当前查看中显示）
  - `ProcessOCRTool`: 基础OCR功能
  - `OCRWithLayoutTool`: 保持布局的OCR

- **`formula_recognition.py`**: 公式识别工具（未在当前查看中显示）
  - `ExtractFormulasTool`: 数学公式提取
  - `FormulaToLatexTool`: 公式转LaTeX格式

- **`pdf_analysis.py`**: PDF分析工具（未在当前查看中显示）
  - `AnalyzePDFTool`: PDF结构和内容分析
  - `DetectPDFTypeTool`: PDF类型检测

- **`full_pipeline.py`**: 完整处理管道（未在当前查看中显示）
  - `FullPipelineTool`: 完整PDF处理流程
  - `SmartProcessingTool`: 智能处理选择

#### MCP协议模块 (`mcp/`)
- **`server.py`**: MCP服务器实现（未在当前查看中显示）
- **`protocol.py`**: MCP协议处理（未在当前查看中显示）
- **`exceptions.py`**: MCP异常定义（未在当前查看中显示）
- **`tools.py`**: MCP工具基类和注册机制（未在当前查看中显示）

#### 其他模块
- **`models/`**: 数据模型定义
- **`processors/`**: 处理器实现
- **`utils/`**: 工具函数
- **`worker.py`**: 后台任务处理器
- **`http_app.py`**: HTTP API接口（可选）
- **`cli.py`**: 命令行接口

### 测试目录 (`tests/`)
- **`test_pdf_mcp_server.py`**: 主要测试文件
  - 服务器初始化测试
  - 工具注册测试
  - 协议处理测试
  - 文本提取功能测试

- **`test_docx_exporter.py`**: DOCX导出测试
- **`test_http_docx.py`**: HTTP DOCX接口测试

### 配置目录 (`config/`)
- **`example_config.json`**: 示例配置文件

### 示例目录 (`examples/`)
- **`basic_usage.py`**: 基础使用示例
- **`advanced_usage.py`**: 高级使用示例

### 文档目录 (`docs/`)
- 项目文档（目录存在但内容未查看）

### 临时目录
- **`temp/`**: 临时文件存储
- **`temp_test/`**: 测试临时文件

## 核心功能模块详解

### 1. 文本提取模块
**功能**: 从PDF文件中提取文本内容
**支持的引擎**:
- PyMuPDF: 高性能，支持复杂布局
- pdfplumber: 精确布局分析
- PyPDF2: 轻量级基础提取

**特性**:
- 自动选择最佳提取引擎
- 页面选择性提取
- 布局保持选项
- 注释和元数据提取

### 2. 表格提取模块
**功能**: 识别和提取PDF中的表格数据
**支持的引擎**:
- Camelot: 高精度表格检测
- Tabula: Java基础的表格提取
- pdfplumber: 基于文本的表格识别

### 3. OCR处理模块
**功能**: 对扫描PDF进行光学字符识别
**技术栈**:
- Tesseract OCR引擎
- OCRmyPDF集成
- 多语言支持

### 4. 公式识别模块
**功能**: 识别和转换数学公式
**技术栈**:
- LaTeX-OCR模型
- pix2tex转换器
- PyTorch深度学习框架

### 5. 智能分析模块
**功能**: 分析PDF结构和内容类型
**特性**:
- 文档类型检测
- 内容结构分析
- 处理建议生成

## 部署架构

### 生产环境
- **主服务**: PDF-MCP Server (端口8000)
- **数据库**: PostgreSQL (端口5432)
- **缓存**: Redis (端口6379)
- **反向代理**: Nginx (端口80/443)
- **监控**: Prometheus + Grafana
- **追踪**: Jaeger

### 开发环境
- **调试支持**: debugpy (端口5678)
- **数据库管理**: pgAdmin (端口5050)
- **缓存管理**: Redis Commander (端口8081)
- **数据分析**: Jupyter Notebook (端口8888)
- **文件管理**: File Browser (端口8080)

## 配置系统

### 环境变量
- `PDF_MCP_HOST`: 服务器主机地址
- `PDF_MCP_PORT`: 服务器端口
- `PDF_MCP_LOG_LEVEL`: 日志级别
- `PDF_MCP_ENABLE_*`: 功能开关
- `PDF_MCP_DB_URL`: 数据库连接
- `PDF_MCP_REDIS_URL`: Redis连接

### 配置文件结构
```json
{
  "server": {
    "name": "pdf-mcp-server",
    "version": "1.0.0",
    "max_concurrent_requests": 10,
    "temp_dir": "./temp"
  },
  "tools": {
    "text_extraction": {"enabled": true},
    "table_extraction": {"enabled": true},
    "ocr": {"enabled": true},
    "formula_recognition": {"enabled": true}
  }
}
```

## 安全考虑

1. **文件验证**: 文件大小和类型限制
2. **路径安全**: 防止路径遍历攻击
3. **临时文件**: 自动清理机制
4. **访问控制**: 可配置的文件访问白名单
5. **日志脱敏**: 敏感信息处理

## 性能优化

1. **GPU加速**: 公式识别模型支持CUDA
2. **内存管理**: 大文件分页处理
3. **并发处理**: 异步处理架构
4. **缓存机制**: Redis缓存常用结果
5. **资源限制**: Docker容器资源配额

## 扩展性

1. **插件架构**: 工具模块化设计
2. **多引擎支持**: 每个功能支持多种实现
3. **配置驱动**: 功能可通过配置启用/禁用
4. **协议标准**: 基于MCP标准协议
5. **容器化**: 支持Kubernetes部署

## 监控和日志

1. **健康检查**: HTTP健康检查端点
2. **指标收集**: Prometheus指标
3. **日志聚合**: 结构化日志输出
4. **分布式追踪**: Jaeger集成
5. **可视化**: Grafana仪表板

## 开发工作流

1. **代码质量**: Black格式化, flake8检查, mypy类型检查
2. **测试框架**: pytest异步测试
3. **持续集成**: Docker多阶段构建
4. **开发环境**: docker-compose开发栈
5. **调试支持**: 远程调试配置

这个项目展现了现代Python服务的最佳实践，包括容器化部署、微服务架构、监控体系和开发工具链的完整集成。